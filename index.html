<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Dados del Tesoro - Playa | Arkana Games</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Poppins:wght@400;600;700&display=swap');

    :root{
      --sky1:#7ad7ff; --sky2:#3aa2ff;
      --sea1:#1aa8ff; --sea2:#0b5ed7;
      --sand1:#ffe2a8; --sand2:#f6c776;
      --teal:#18d5c8; --gold:#ffd700;
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Poppins',sans-serif;
      min-height:100vh;
      overflow-x:hidden;
      color:#fff;
      background:
        radial-gradient(circle at 80% 10%, rgba(255,216,107,.45), transparent 35%),
        radial-gradient(circle at 15% 20%, rgba(24,213,200,.20), transparent 45%),
        linear-gradient(180deg, var(--sky1) 0%, var(--sky2) 35%, var(--sea1) 60%, var(--sea2) 100%);
    }

    .loading-screen{
      position:fixed; inset:0;
      background:
        radial-gradient(circle at 70% 25%, rgba(255,216,107,.55), transparent 45%),
        linear-gradient(180deg, var(--sky1) 0%, var(--sky2) 45%, var(--sea1) 100%);
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      z-index:1000;
      transition:opacity .8s ease, visibility .8s ease;
    }
    .loading-screen.hidden{ opacity:0; visibility:hidden; }
    .loading-logo{
      width:170px; height:auto;
      margin-bottom:22px;
      animation:logoPulse 2s ease-in-out infinite;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.35));
    }
    @keyframes logoPulse{
      0%,100%{ transform:scale(1); }
      50%{ transform:scale(1.05); }
    }
    .loading-dice{ display:flex; gap:16px; margin-bottom:20px; }
    .loading-die{
      width:50px; height:50px;
      border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      font-size:24px; font-weight:900;
      color:#145b67;
      background: linear-gradient(145deg, #fff 0%, #eaf6ff 100%);
      box-shadow: 0 12px 25px rgba(0,0,0,.25), inset 0 2px 0 rgba(255,255,255,.8);
      animation: diceRoll 1s ease-in-out infinite;
    }
    .loading-die:nth-child(2){ animation-delay:.2s; }
    @keyframes diceRoll{
      0%,100%{ transform: rotateZ(0deg) translateY(0); }
      25%{ transform: rotateZ(10deg) translateY(-10px); }
      75%{ transform: rotateZ(-10deg) translateY(-5px); }
    }
    .loading-text{
      font-family:'Cinzel',serif;
      font-size:1.35rem;
      letter-spacing:1px;
      color:#fff;
      text-shadow:0 0 18px rgba(255,216,107,.55);
      margin-bottom:16px;
    }
    .loading-bar-container{
      width:260px; height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }
    .loading-bar{
      height:100%;
      background: linear-gradient(90deg, var(--gold), #ffb74a, var(--teal), var(--gold));
      border-radius:999px;
      animation: loadingProgress 2s ease-in-out forwards;
    }
    @keyframes loadingProgress{ 0%{ width:0%; } 100%{ width:100%; } }

    .game-container{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px;
      padding-bottom:28px;
      position:relative;
      z-index:2;
    }

    .header{ text-align:center; margin-bottom:12px; width:100%; }
    .logo{
      width:120px;
      height:auto;
      margin-bottom:8px;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
    }

    .promo-banner{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:9px 22px;
      border-radius:999px;
      background: linear-gradient(145deg, rgba(0,0,0,.20), rgba(255,255,255,.10));
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      margin-bottom:12px;
      backdrop-filter: blur(6px);
    }
    .promo-banner span{
      color:#fff;
      font-weight:700;
      font-size:.85rem;
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }

    .game-title{
      font-family:'Cinzel',serif;
      font-weight:900;
      font-size: clamp(1.7rem, 6vw, 2.8rem);
      background: linear-gradient(180deg, #fff 0%, #fff4d1 30%, var(--gold) 60%, #ffb74a 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
      margin-bottom:6px;
    }
    .game-subtitle{
      color: rgba(255,255,255,.92);
      font-size:.95rem;
      max-width:420px;
      margin:0 auto;
      line-height:1.4;
      text-shadow:0 2px 10px rgba(0,0,0,.22);
    }

    .canvas-container{
      width:100%;
      max-width:640px;
      aspect-ratio: 4/3;
      border-radius:22px;
      overflow:hidden;
      position:relative;
      margin-bottom:18px;
      box-shadow:
        0 0 0 3px rgba(255,255,255,.25),
        0 0 0 7px rgba(255,216,107,.65),
        0 24px 70px rgba(0,0,0,.45);
      background:
        radial-gradient(circle at 80% 10%, rgba(255,216,107,.35), transparent 35%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.05));
    }

    .rope{
      position:absolute;
      top:10px; left:12px; right:12px;
      height:14px;
      border-radius:999px;
      background: linear-gradient(90deg, #f4d29e, #caa26a, #f4d29e);
      opacity:.85;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
      z-index:9;
    }
    .rope::after{
      content:"";
      position:absolute;
      left:10px; right:10px; top:5px;
      height:3px; border-radius:999px;
      background: rgba(255,255,255,.25);
    }

    #game-canvas{ width:100%; height:100%; display:block; }

    .score-display{
      position:absolute;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      padding:10px 28px;
      border-radius:999px;
      background: linear-gradient(145deg, rgba(0,0,0,.40), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 25px rgba(0,0,0,.25), inset 0 0 22px rgba(255,216,107,.15);
      backdrop-filter: blur(6px);
      z-index:10;
      display:none;
    }
    .score-display span{
      font-family:'Cinzel',serif;
      font-size:1.7rem;
      font-weight:900;
      color:#fff;
      text-shadow:0 0 18px rgba(255,216,107,.55);
    }

    .roll-button{
      border:none;
      padding:18px 50px;
      border-radius:999px;
      cursor:pointer;
      font-family:'Cinzel',serif;
      font-size:1.25rem;
      font-weight:800;
      color:#05202a;
      background: linear-gradient(145deg, #fff 0%, #fff1cc 30%, var(--gold) 70%, #ffb74a 100%);
      box-shadow:
        0 7px 0 rgba(151,111,22,.9),
        0 16px 40px rgba(0,0,0,.28),
        inset 0 2px 0 rgba(255,255,255,.75);
      transition: transform .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
      margin-bottom:16px;
    }
    .roll-button:hover:not(:disabled){ transform: translateY(-3px); }
    .roll-button:active:not(:disabled){ transform: translateY(3px); }
    .roll-button:disabled{
      background: linear-gradient(145deg, rgba(255,255,255,.20), rgba(0,0,0,.18));
      color: rgba(255,255,255,.55);
      box-shadow: 0 5px 0 rgba(0,0,0,.25);
      cursor:not-allowed;
    }

    .timer-container{
      display:none;
      padding:14px 26px;
      border-radius:16px;
      background: linear-gradient(145deg, rgba(0,0,0,.35), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      text-align:center;
      margin-bottom:16px;
    }
    .timer-container.visible{ display:block; }
    .timer-label{ color: rgba(255,255,255,.9); font-size:.9rem; margin-bottom:6px; }
    .timer-value{
      font-family:'Cinzel',serif;
      font-size:2rem;
      font-weight:900;
      color:#fff;
      text-shadow:0 0 18px rgba(24,213,200,.35);
    }

    .prize-table{
      max-width:420px;
      width:100%;
      border-radius:16px;
      padding:14px 18px;
      background: linear-gradient(145deg, rgba(255,255,255,.12), rgba(0,0,0,.22));
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: 0 18px 42px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      margin-bottom:16px;
    }
    .prize-table h3{
      font-family:'Cinzel',serif;
      font-size:1.05rem;
      color:#fff;
      text-shadow: 0 0 18px rgba(255,216,107,.35);
      margin-bottom:10px;
      text-align:center;
    }
    .prize-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .prize-row:last-child{ border-bottom:none; }
    .prize-score{ font-weight:700; color:rgba(255,255,255,.95); }
    .prize-name{ font-weight:800; color: #fff; }
    .prize-name b{ color: var(--gold); }

    .instructions{
      max-width:460px;
      width:100%;
      border-radius:14px;
      padding:14px 18px;
      background: linear-gradient(145deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 42px rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
      text-align:center;
    }
    .instructions p{ font-size:.86rem; color: rgba(255,255,255,.92); margin:5px 0; }

    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:2000;
      backdrop-filter: blur(7px);
      padding:16px;
    }
    .modal-overlay.visible{ display:flex; }
    .modal-content{
      width:min(420px, 92vw);
      border-radius:24px;
      padding:34px 26px;
      background:
        radial-gradient(circle at 80% 10%, rgba(255,216,107,.22), transparent 45%),
        linear-gradient(145deg, rgba(255,255,255,.12), rgba(0,0,0,.35));
      border: 2px solid rgba(255,255,255,.22);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      text-align:center;
      animation: modalAppear .45s ease;
    }
    @keyframes modalAppear{
      0%{ transform: scale(.85) translateY(10px); opacity:0; }
      100%{ transform: scale(1) translateY(0); opacity:1; }
    }
    .modal-dice-result{ display:flex; justify-content:center; gap:16px; margin-bottom:14px; }
    .modal-die{
      width:62px; height:62px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-size:2rem; font-weight:900;
      color:#145b67;
      background: linear-gradient(145deg, #fff 0%, #eaf6ff 100%);
      box-shadow: 0 14px 30px rgba(0,0,0,.28), inset 0 2px 0 rgba(255,255,255,.8);
    }
    .modal-total{
      font-family:'Cinzel',serif;
      font-size:2.6rem;
      font-weight:900;
      color:#fff;
      text-shadow:0 0 22px rgba(255,216,107,.45);
      margin-bottom:10px;
    }
    .modal-prize{
      font-family:'Cinzel',serif;
      font-size:1.35rem;
      font-weight:900;
      color:#fff;
      padding:14px 14px;
      border-radius:14px;
      margin-bottom:18px;
      background: linear-gradient(145deg, rgba(24,213,200,.18), rgba(255,216,107,.18));
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: inset 0 0 24px rgba(255,255,255,.06);
    }
    .modal-close{
      border:none;
      padding:12px 42px;
      border-radius:999px;
      cursor:pointer;
      font-family:'Cinzel',serif;
      font-weight:900;
      color:#05202a;
      background: linear-gradient(145deg, #fff 0%, #fff1cc 35%, var(--gold) 75%, #ffb74a 100%);
      box-shadow: 0 6px 0 rgba(151,111,22,.9);
      transition: transform .18s ease;
    }
    .modal-close:hover{ transform: translateY(-2px); }
    .modal-close:active{ transform: translateY(2px); }

    .confetti-container{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:3000;
      overflow:hidden;
    }
    .confetti{
      position:absolute;
      width:10px; height:10px;
      animation: confettiFall 3s linear forwards;
    }
    @keyframes confettiFall{
      0%{ transform: translateY(-100%) rotate(0deg); opacity:1; }
      100%{ transform: translateY(100vh) rotate(720deg); opacity:0; }
    }

    @media (max-width:480px){
      .canvas-container{ aspect-ratio: 1/1; }
      .roll-button{ padding: 15px 40px; font-size:1.1rem; }
      .modal-content{ padding:24px 18px; }
      .modal-die{ width:52px; height:52px; font-size:1.6rem; }
      .modal-total{ font-size:2.2rem; }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <img src="/images/arkana-20logo.png" alt="Arkana Games" class="loading-logo" />
    <div class="loading-dice">
      <div class="loading-die">üé≤</div>
      <div class="loading-die">üé≤</div>
    </div>
    <div class="loading-text">DADOS DEL TESORO - PLAYA</div>
    <div class="loading-bar-container"><div class="loading-bar"></div></div>
  </div>

  <div class="game-container">
    <header class="header">
      <img src="/images/arkana-20logo.png" alt="Arkana Games" class="logo" />
      <div class="promo-banner"><span>üèñÔ∏è TESORO DE PLAYA ¬∑ BONOS VIP ¬∑ ARKANA GAMES</span></div>
      <h1 class="game-title">üèùÔ∏è DADOS DEL TESORO üèùÔ∏è</h1>
      <p class="game-subtitle">Lanz√° los dados sobre la arena del casino playero y descubr√≠ tu premio.</p>
    </header>

    <div class="canvas-container">
      <div class="rope"></div>
      <div class="score-display" id="scoreDisplay"><span id="scoreValue">0</span></div>
      <canvas id="game-canvas"></canvas>
    </div>

    <button class="roll-button" id="rollButton" onclick="rollDice()">üé≤ LANZAR DADOS üé≤</button>

    <div class="timer-container" id="timerContainer">
      <div class="timer-label">‚è≥ Pr√≥xima oportunidad en:</div>
      <div class="timer-value" id="timerValue">00:00:00</div>
    </div>

    <div class="prize-table">
      <h3>üèÜ TABLA DE PREMIOS üèÜ</h3>
      <div class="prize-row"><span class="prize-score">11-12 puntos</span><span class="prize-name">üè¥‚Äç‚ò†Ô∏è <b>BONO A ELECCI√ìN</b></span></div>
      <div class="prize-row"><span class="prize-score">9-10 puntos</span><span class="prize-name">üíé <b>BONO DEL 200%</b></span></div>
      <div class="prize-row"><span class="prize-score">7-8 puntos</span><span class="prize-name">üåä <b>BONO DEL 150%</b></span></div>
      <div class="prize-row"><span class="prize-score">4-6 puntos</span><span class="prize-name">üçπ <b>BONO DEL 100%</b></span></div>
      <div class="prize-row"><span class="prize-score">2-3 puntos</span><span class="prize-name">üêö <b>BONO SORPRESA</b></span></div>
    </div>

    <div class="instructions">
      <p>üèñÔ∏è Presion√° ‚ÄúLanzar Dados‚Äù para tirarlos sobre la arena</p>
      <p>üéØ La suma visible arriba define tu premio</p>
      <p>üíé Mientras m√°s alto el puntaje, m√°s VIP el tesoro</p>
    </div>
  </div>

  <div class="modal-overlay" id="resultModal">
    <div class="modal-content">
      <div class="modal-dice-result">
        <div class="modal-die" id="modalDie1">‚öÄ</div>
        <div class="modal-die" id="modalDie2">‚öÄ</div>
      </div>
      <div class="modal-total">TOTAL: <span id="modalTotal">2</span></div>
      <div class="modal-prize" id="modalPrize">¬°PREMIO!</div>
      <button class="modal-close" onclick="closeModal()">ACEPTAR</button>
    </div>
  </div>

  <div class="confetti-container" id="confettiContainer"></div>

  <script>
    // =========================
    // Three.js
    // =========================
    let scene, camera, renderer;
    let dice1, dice2;
    let isRolling = false;

    // bounds para que NO se vayan fuera de escena
    const SAFE_BOUNDS = { minX:-2.6, maxX:2.6, minZ:-1.7, maxZ:1.8, y:0.55 };

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    // =========================
    // Anti-superposici√≥n (visual): evita que los dados se "mezclen"
    // =========================
    const DICE_MIN_SEP = 1.55;   // separaci√≥n m√≠nima en el plano XZ (seguro aun con rotaci√≥n)
    const DICE_MIN_X_GAP = 1.35; // separaci√≥n m√≠nima en X para que se vean ambos (evita tapado por perspectiva)

    function enforceDiceSeparation(){
      for(let k=0;k<3;k++){
        let dx = dice2.position.x - dice1.position.x;
        let dz = dice2.position.z - dice1.position.z;
        let dist = Math.sqrt(dx*dx + dz*dz);

        if(dist < DICE_MIN_SEP){
          let nx, nz;
          if(dist < 1e-4){
            nx = 1; nz = 0;
            dist = 1;
          } else {
            nx = dx / dist;
            nz = dz / dist;
          }
          const push = (DICE_MIN_SEP - dist) * 0.5;
          dice1.position.x -= nx * push;
          dice1.position.z -= nz * push;
          dice2.position.x += nx * push;
          dice2.position.z += nz * push;
        }

        dx = dice2.position.x - dice1.position.x;
        const absDx = Math.abs(dx);
        if(absDx < DICE_MIN_X_GAP){
          const dir = (dx === 0) ? 1 : Math.sign(dx);
          const need = (DICE_MIN_X_GAP - absDx) * 0.5;
          dice1.position.x -= dir * need;
          dice2.position.x += dir * need;
        }

        dice1.position.x = clamp(dice1.position.x, SAFE_BOUNDS.minX, SAFE_BOUNDS.maxX);
        dice1.position.z = clamp(dice1.position.z, SAFE_BOUNDS.minZ, SAFE_BOUNDS.maxZ);
        dice2.position.x = clamp(dice2.position.x, SAFE_BOUNDS.minX, SAFE_BOUNDS.maxX);
        dice2.position.z = clamp(dice2.position.z, SAFE_BOUNDS.minZ, SAFE_BOUNDS.maxZ);
      }
    }

    // =========================
    // LocalStorage propio de ESTA p√°gina (premio persistente)
    // =========================
    const LS_PREFIX = 'arkana_dados_tesoro_playa_v1';
    const LS_LAST_PLAY = `${LS_PREFIX}_lastPlay`;     // mantiene tu timer actual
    const LS_LAST_PRIZE = `${LS_PREFIX}_lastPrize`;   // guarda el resultado/premio

    // =========================
    // Audio (desde /assets)
    // =========================
    // Cambi√° los nombres si tus archivos tienen otro nombre:
    const AUDIO = {
      bg:   '/assets/background.mp3', // loop background
      roll: '/assets/roll.mp3',       // movimiento de dados
      popup:'/assets/popup.mp3'       // aparece el popup
    };

    let bgAudio = null;
    let audioUnlocked = false;

    function ensureBackgroundAudio(){
      if(bgAudio) return;
      bgAudio = new Audio(AUDIO.bg);
      bgAudio.loop = true;
      bgAudio.volume = 0.25;
      bgAudio.preload = 'auto';
    }

    function unlockAudioAndStartBG(){
      if(audioUnlocked) return;
      audioUnlocked = true;

      ensureBackgroundAudio();
      // Intentamos reproducir; si el navegador bloquea, ya quedar√° listo para el pr√≥ximo gesto.
      bgAudio.play().catch(()=>{});
    }

    function sfx(url, volume){
      try{
        // sfx independiente para no cortar el background
        const a = new Audio(url);
        a.volume = volume;
        a.play().catch(()=>{});
      }catch(e){}
    }

    // =========================
    // Mapeo de caras por normal local (BoxGeometry: px,nx,py,ny,pz,nz)
    // =========================
    const FACE_BY_LOCAL_NORMAL = [
      { n: new THREE.Vector3(0, 1, 0), value: 1 }, // +Y top
      { n: new THREE.Vector3(0,-1, 0), value: 6 }, // -Y bottom
      { n: new THREE.Vector3(1, 0, 0), value: 3 }, // +X
      { n: new THREE.Vector3(-1,0, 0), value: 4 }, // -X
      { n: new THREE.Vector3(0, 0, 1), value: 2 }, // +Z
      { n: new THREE.Vector3(0, 0,-1), value: 5 }  // -Z
    ];

    function getTopFaceValue(dice){
      const worldUp = new THREE.Vector3(0,1,0);
      let best = { value: 1, dot: -Infinity };
      for(const f of FACE_BY_LOCAL_NORMAL){
        const n = f.n.clone().applyQuaternion(dice.quaternion).normalize();
        const d = n.dot(worldUp);
        if(d > best.dot) best = { value: f.value, dot: d };
      }
      return best.value;
    }

    function initScene() {
      const canvas = document.getElementById('game-canvas');
      const container = canvas.parentElement;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x6fd3ff);
      scene.fog = new THREE.Fog(0x6fd3ff, 12, 28);

      const aspect = container.clientWidth / container.clientHeight;
      camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
      camera.position.set(0, 8.2, 7.0);
      camera.lookAt(0, 0.55, 0);

      renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;

      scene.add(new THREE.AmbientLight(0xffffff, 0.55));

      const sun = new THREE.DirectionalLight(0xfff0c8, 1.15);
      sun.position.set(8, 12, 6);
      sun.castShadow = true;
      sun.shadow.mapSize.width = 2048;
      sun.shadow.mapSize.height = 2048;
      sun.shadow.camera.near = 1;
      sun.shadow.camera.far = 40;
      sun.shadow.camera.left = -12;
      sun.shadow.camera.right = 12;
      sun.shadow.camera.top = 12;
      sun.shadow.camera.bottom = -12;
      scene.add(sun);

      const rim = new THREE.DirectionalLight(0x9befff, 0.35);
      rim.position.set(-8, 6, -8);
      scene.add(rim);

      createBeachTable();
      createBeachDecor();

      dice1 = createDice(-1.0, SAFE_BOUNDS.y, 0.2);
      dice2 = createDice( 1.0, SAFE_BOUNDS.y, 0.0);

      window.addEventListener('resize', onWindowResize);
      animate();
    }

    function createBeachTable(){
      const sandMat = new THREE.MeshStandardMaterial({ color: 0xf2c77b, roughness:0.95 });
      const waterMat = new THREE.MeshStandardMaterial({ color: 0x1aa8ff, roughness:0.35, transparent:true, opacity:0.92 });
      const foamMat  = new THREE.MeshStandardMaterial({ color: 0xc9f3ff, roughness:0.6, transparent:true, opacity:0.65 });

      const sand = new THREE.Mesh(new THREE.BoxGeometry(12, 0.6, 9), sandMat);
      sand.position.y = -0.3;
      sand.receiveShadow = true;
      scene.add(sand);

      const borderMat = new THREE.MeshStandardMaterial({ color: 0xb07538, roughness:0.55 });
      const borders = [
        { w: 12.5, h: 0.45, d: 0.35, x: 0,   y: 0.1, z: 4.65 },
        { w: 12.5, h: 0.45, d: 0.35, x: 0,   y: 0.1, z: -4.65 },
        { w: 0.35, h: 0.45, d: 9.6,  x: 6.1, y: 0.1, z: 0 },
        { w: 0.35, h: 0.45, d: 9.6,  x: -6.1,y: 0.1, z: 0 }
      ];
      borders.forEach(b=>{
        const m = new THREE.Mesh(new THREE.BoxGeometry(b.w,b.h,b.d), borderMat);
        m.position.set(b.x,b.y,b.z);
        m.castShadow = true;
        scene.add(m);
      });

      const water = new THREE.Mesh(new THREE.BoxGeometry(11.2, 0.18, 2.2), waterMat);
      water.position.set(0, 0.08, -2.9);
      scene.add(water);

      for(let i=0;i<3;i++){
        const foam = new THREE.Mesh(new THREE.BoxGeometry(11.0, 0.08, 0.35), foamMat);
        foam.position.set(0, 0.15 + i*0.05, -2.2 + i*0.25);
        foam.rotation.y = (i%2? 0.02 : -0.02);
        scene.add(foam);
      }
    }

    function createBeachDecor(){
      const goldMat = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness:0.25, metalness:0.85 });

      const coinGeo = new THREE.CylinderGeometry(0.28, 0.28, 0.07, 32);
      const positions = [{x:-4.2,z:-3.4},{x:4.0,z:-3.5},{x:-4.2,z:3.4},{x:4.1,z:3.3}];
      positions.forEach((p)=>{
        for(let j=0;j<3;j++){
          const coin = new THREE.Mesh(coinGeo, goldMat);
          coin.position.set(p.x + (Math.random()-0.5)*0.35, 0.05 + j*0.07, p.z + (Math.random()-0.5)*0.35);
          coin.rotation.x = Math.PI/2;
          coin.rotation.z = Math.random()*Math.PI;
          coin.castShadow = true;
          scene.add(coin);
        }
      });

      const chest = makeChest(goldMat);
      chest.position.set(0, 0.18, -3.7);
      chest.scale.set(0.95,0.95,0.95);
      scene.add(chest);
    }

    function makeChest(goldMat){
      const g = new THREE.Group();
      const wood  = new THREE.MeshStandardMaterial({ color: 0x7a4a22, roughness:0.7 });
      const strap = new THREE.MeshStandardMaterial({ color: 0x3b2a1a, roughness:0.8 });

      const base = new THREE.Mesh(new THREE.BoxGeometry(2.0, 0.8, 1.2), wood);
      base.position.y = 0.4; base.castShadow = true; base.receiveShadow = true; g.add(base);

      const lid = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 2.0, 24, 1, false, 0, Math.PI), wood);
      lid.rotation.z = Math.PI/2; lid.position.y = 1.0; lid.castShadow = true; g.add(lid);

      const band1 = new THREE.Mesh(new THREE.BoxGeometry(2.05, 0.10, 1.22), strap);
      band1.position.y = 0.78; band1.castShadow = true; g.add(band1);

      const band2 = new THREE.Mesh(new THREE.BoxGeometry(2.05, 0.10, 1.22), strap);
      band2.position.y = 1.12; band2.castShadow = true; g.add(band2);

      const lock = new THREE.Mesh(new THREE.BoxGeometry(0.28, 0.30, 0.10), goldMat);
      lock.position.set(0, 0.55, 0.62); lock.castShadow = true; g.add(lock);

      g.rotation.y = Math.PI;
      return g;
    }

    function createDice(x,y,z){
      const size = 0.85;
      const geo = new THREE.BoxGeometry(size,size,size);

      const mats = [
        createFaceMaterial(3),
        createFaceMaterial(4),
        createFaceMaterial(1),
        createFaceMaterial(6),
        createFaceMaterial(2),
        createFaceMaterial(5)
      ];

      const dice = new THREE.Mesh(geo, mats);
      dice.position.set(x,y,z);
      dice.castShadow = true;
      dice.receiveShadow = true;

      const edges = new THREE.EdgesGeometry(geo);
      const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x7aa9b8 }));
      line.material.transparent = true;
      line.material.opacity = 0.55;
      dice.add(line);

      scene.add(dice);
      return dice;
    }

    function createFaceMaterial(number){
      const c = document.createElement('canvas');
      c.width = 128; c.height = 128;
      const ctx = c.getContext('2d');

      const grad = ctx.createRadialGradient(44, 44, 10, 64, 64, 90);
      grad.addColorStop(0, '#ffffff');
      grad.addColorStop(1, '#eaf6ff');
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,128,128);

      ctx.strokeStyle = 'rgba(20,91,103,.18)';
      ctx.lineWidth = 6;
      ctx.strokeRect(6,6,116,116);

      ctx.fillStyle = '#145b67';
      const dots = getDotPositions(number);
      dots.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x,p.y,12,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,.35)';
        ctx.beginPath();
        ctx.arc(p.x-4,p.y-4,4.5,0,Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#145b67';
      });

      const tex = new THREE.CanvasTexture(c);
      tex.anisotropy = 4;
      return new THREE.MeshStandardMaterial({ map: tex, roughness:0.35, metalness:0.05 });
    }

    function getDotPositions(n){
      const center = { x:64, y:64 };
      const pos = {
        1:[center],
        2:[{x:32,y:32},{x:96,y:96}],
        3:[{x:32,y:32},center,{x:96,y:96}],
        4:[{x:32,y:32},{x:96,y:32},{x:32,y:96},{x:96,y:96}],
        5:[{x:32,y:32},{x:96,y:32},center,{x:32,y:96},{x:96,y:96}],
        6:[{x:32,y:32},{x:96,y:32},{x:32,y:64},{x:96,y:64},{x:32,y:96},{x:96,y:96}]
      };
      return pos[n];
    }

    function onWindowResize(){
      const container = document.getElementById('game-canvas').parentElement;
      const w = container.clientWidth;
      const h = container.clientHeight;
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      renderer.setSize(w,h);
    }

    function animate(){
      requestAnimationFrame(animate);
      camera.lookAt(0, 0.55, 0);
      renderer.render(scene, camera);
    }

    // =========================
    // Tirada REALISTA: NO vuelve al centro
    // =========================
    function rollDice(){
      if(isRolling) return;

      // desbloquea audio + inicia background en el primer gesto del usuario
      unlockAudioAndStartBG();

      const lastPlay = localStorage.getItem(LS_LAST_PLAY);
      if(lastPlay){
        const timeSince = Date.now() - parseInt(lastPlay,10);
        if(timeSince < 24*60*60*1000) return;
      }

      isRolling = true;
      document.getElementById('rollButton').disabled = true;
      document.getElementById('scoreDisplay').style.display = 'block';

      // sonido de movimiento de dados
      sfx(AUDIO.roll, 0.60);

      simulateRollNoReturn();
    }

    function simulateRollNoReturn(){
      const duration = 2300;
      const start = performance.now();

      dice1.position.y = Math.max(dice1.position.y, 0.9);
      dice2.position.y = Math.max(dice2.position.y, 1.0);

      const vel1 = { x: (Math.random()*0.06 - 0.03), z: (0.09 + Math.random()*0.05), rx: 0.18 + Math.random()*0.10, ry: 0.12 + Math.random()*0.10, rz: 0.10 + Math.random()*0.08 };
      const vel2 = { x: (Math.random()*0.06 - 0.03), z: (0.09 + Math.random()*0.05), rx: 0.18 + Math.random()*0.10, ry: 0.12 + Math.random()*0.10, rz: 0.10 + Math.random()*0.08 };

      if(dice1.position.z > 1.0) vel1.z *= -1;
      if(dice2.position.z > 1.0) vel2.z *= -1;

      dice1.rotation.x += Math.random()*Math.PI;
      dice1.rotation.y += Math.random()*Math.PI;
      dice1.rotation.z += Math.random()*Math.PI;

      dice2.rotation.x += Math.random()*Math.PI;
      dice2.rotation.y += Math.random()*Math.PI;
      dice2.rotation.z += Math.random()*Math.PI;

      function tick(){
        const now = performance.now();
        const t = Math.min((now - start)/duration, 1);

        const friction = 1 - Math.pow(t, 1.6);
        const bounce = Math.sin(t * Math.PI * 3) * (1 - t) * 0.9;

        dice1.position.x += vel1.x * friction;
        dice1.position.z += vel1.z * friction;
        dice1.position.y = SAFE_BOUNDS.y + Math.max(0, bounce);

        dice2.position.x += vel2.x * friction;
        dice2.position.z += vel2.z * friction;
        dice2.position.y = SAFE_BOUNDS.y + Math.max(0, bounce*0.9);

        dice1.rotation.x += vel1.rx * friction;
        dice1.rotation.y += vel1.ry * friction;
        dice1.rotation.z += vel1.rz * friction;

        dice2.rotation.x += vel2.rx * friction;
        dice2.rotation.y += vel2.ry * friction;
        dice2.rotation.z += vel2.rz * friction;

        dice1.position.x = clamp(dice1.position.x, SAFE_BOUNDS.minX, SAFE_BOUNDS.maxX);
        dice1.position.z = clamp(dice1.position.z, SAFE_BOUNDS.minZ, SAFE_BOUNDS.maxZ);
        dice2.position.x = clamp(dice2.position.x, SAFE_BOUNDS.minX, SAFE_BOUNDS.maxX);
        dice2.position.z = clamp(dice2.position.z, SAFE_BOUNDS.minZ, SAFE_BOUNDS.maxZ);

        enforceDiceSeparation();

        if(t < 0.92){
          document.getElementById('scoreValue').textContent = (2 + Math.floor(Math.random()*11));
          requestAnimationFrame(tick);
        } else {
          freezeAndResolve();
        }
      }

      requestAnimationFrame(tick);

      function freezeAndResolve(){
        enforceDiceSeparation();

        dice1.position.y = SAFE_BOUNDS.y;
        dice2.position.y = SAFE_BOUNDS.y;

        const v1 = getTopFaceValue(dice1);
        const v2 = getTopFaceValue(dice2);
        const total = v1 + v2;

        document.getElementById('scoreValue').textContent = total;

        setTimeout(()=>{
          showResult(v1, v2, total);
        }, 550);
      }
    }

    function showResult(d1, d2, total){
      document.getElementById('modalDie1').textContent = getDieFace(d1);
      document.getElementById('modalDie2').textContent = getDieFace(d2);
      document.getElementById('modalTotal').textContent = total;

      const prize = calculatePrize(total);
      document.getElementById('modalPrize').innerHTML = prize.html;

      // guarda premio para que al recargar vuelva a mostrarse
      try{
        localStorage.setItem(LS_LAST_PRIZE, JSON.stringify({
          d1, d2, total,
          prizeHtml: prize.html,
          at: Date.now()
        }));
      }catch(e){}

      document.getElementById('resultModal').classList.add('visible');

      // sonido popup (aparece modal)
      sfx(AUDIO.popup, 0.60);

      if(total >= 7){ createConfetti(); }

      localStorage.setItem(LS_LAST_PLAY, Date.now().toString());
      updateTimer();
    }

    function getDieFace(v){
      const faces = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
      return faces[v];
    }

    function calculatePrize(total){
      if (total >= 11) return { html: 'üè¥‚Äç‚ò†Ô∏è <span style="color:#ffd700;">¬°TESORO A ELECCI√ìN!</span><br><span style="font-size:.95rem; opacity:.9;">Eleg√≠ tu bono VIP</span>' };
      if (total >= 9)  return { html: 'üíé <span style="color:#ffd700;">¬°BONO DEL 200%!</span><br><span style="font-size:.95rem; opacity:.9;">Nivel diamante</span>' };
      if (total >= 7)  return { html: 'üåä <span style="color:#ffd700;">¬°BONO DEL 150%!</span><br><span style="font-size:.95rem; opacity:.9;">Marea alta</span>' };
      if (total >= 4)  return { html: 'üçπ <span style="color:#ffd700;">¬°BONO DEL 100%!</span><br><span style="font-size:.95rem; opacity:.9;">Happy hour playero</span>' };
      return { html: 'üêö <span style="color:#ffd700;">¬°BONO SORPRESA!</span><br><span style="font-size:.95rem; opacity:.9;">Una perlita para vos</span>' };
    }

    function closeModal(){
      document.getElementById('resultModal').classList.remove('visible');
      isRolling = false;
      document.getElementById('timerContainer').classList.add('visible');
    }

    // =========================
    // Timer (24h)
    // =========================
    function updateTimer(){
      const lastPlay = localStorage.getItem(LS_LAST_PLAY);
      if(!lastPlay){
        document.getElementById('timerContainer').classList.remove('visible');
        document.getElementById('rollButton').disabled = false;
        return;
      }

      const timeSince = Date.now() - parseInt(lastPlay, 10);
      const remaining = 24*60*60*1000 - timeSince;

      if(remaining <= 0){
        localStorage.removeItem(LS_LAST_PLAY);
        document.getElementById('timerContainer').classList.remove('visible');
        document.getElementById('rollButton').disabled = false;
        return;
      }

      document.getElementById('timerContainer').classList.add('visible');
      document.getElementById('rollButton').disabled = true;

      const h = Math.floor(remaining / (1000*60*60));
      const m = Math.floor((remaining % (1000*60*60)) / (1000*60));
      const s = Math.floor((remaining % (1000*60)) / 1000);

      document.getElementById('timerValue').textContent =
        `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

      setTimeout(updateTimer, 1000);
    }

    // =========================
    // Confetti
    // =========================
    function createConfetti(){
      const container = document.getElementById('confettiContainer');
      const colors = ['#ffd700','#ff4d7d','#18d5c8','#7ad7ff','#ffffff','#ffb74a','#1aa8ff','#ffe2a8'];

      for(let i=0;i<110;i++){
        setTimeout(()=>{
          const c = document.createElement('div');
          c.className = 'confetti';
          c.style.left = Math.random()*100 + '%';
          c.style.background = colors[Math.floor(Math.random()*colors.length)];
          c.style.animationDuration = (Math.random()*2 + 2) + 's';
          c.style.animationDelay = (Math.random()*0.5) + 's';
          if(Math.random()>0.55) c.style.borderRadius = '50%';
          container.appendChild(c);
          setTimeout(()=>c.remove(), 4200);
        }, i*24);
      }
    }

    // =========================
    // Mostrar premio guardado al recargar (si existe)
    // =========================
    function showSavedPrizeIfAny(){
      let saved = null;
      try{
        const raw = localStorage.getItem(LS_LAST_PRIZE);
        if(raw) saved = JSON.parse(raw);
      }catch(e){}

      if(!saved) return;

      // pinta el modal con el premio guardado
      document.getElementById('scoreDisplay').style.display = 'block';
      document.getElementById('scoreValue').textContent = saved.total ?? 0;

      document.getElementById('modalDie1').textContent = getDieFace(saved.d1 || 1);
      document.getElementById('modalDie2').textContent = getDieFace(saved.d2 || 1);
      document.getElementById('modalTotal').textContent = saved.total ?? 2;
      document.getElementById('modalPrize').innerHTML = saved.prizeHtml || calculatePrize(saved.total ?? 2).html;

      document.getElementById('resultModal').classList.add('visible');
    }

    // Init
    window.onload = function(){
      setTimeout(()=>{
        document.getElementById('loadingScreen').classList.add('hidden');
        initScene();
        updateTimer();

        // prepara bg audio
        ensureBackgroundAudio();

        // desbloqueo de audio al primer gesto en la p√°gina (por pol√≠ticas de autoplay)
        const unlockOnce = () => {
          unlockAudioAndStartBG();
          window.removeEventListener('pointerdown', unlockOnce);
          window.removeEventListener('keydown', unlockOnce);
        };
        window.addEventListener('pointerdown', unlockOnce, { once:false });
        window.addEventListener('keydown', unlockOnce, { once:false });

        // muestra el premio persistido (si existe) al recargar
        // (lo hacemos luego de initScene para que todo est√© listo)
        setTimeout(()=>{ showSavedPrizeIfAny(); }, 180);

      }, 2200);
    };
  </script>
</body>
</html>
